{% assign collection = collections['all'] %}
{% assign current_variant = product.selected_or_first_available_variant %}
{% assign featured_image = current_variant.featured_image | default: product.featured_image %}

<div class="gap-main-border">
  <div class="main-border">
    <div class="top-menu">
      <div class="top-menu-right">
        <h1 class="title">{{ collection.title }}</h1>
        <button class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div class="top-menu-left">
        <div class="top-menu-content">
          <a href="javascript&colon;history.back()">
            <div class="button">BACK</div>
          </a>
          <a href="{{ paginate.next.url }}">
            <div class="button">NEXT</div>
          </a>
        </div>
        <div class="top-menu-content">
          <div id="cart" class="button">
            <a>CART</a>
          </div>
          <div class="button buckscc-currency-box" id="button-currency">
          </div>
        </div>
      </div>
    </div>
    <div class="bar">
      <div class="left-bar">
        <nav role="navigation">
          {%- for link in linklists.main-menu.links -%}
            <div class="widget-left-bar">
              <a {% comment  %} href="{{ link.url }}" {% endcomment %} {% if link.active %}aria-current="page"{% endif %}>
                <h2>{{ link.title }}</h2>
              </a>
              {%- if link.links != blank -%}
                <ul>
                  {%- for child_link in link.links -%}
                    <li>
                      <a href="{{ child_link.url }}" {% if child_link.active %}aria-current="page"{% endif %}>
                        {{ child_link.title }}
                      </a>
                      {%- if child_link.links != blank -%}
                        <ul>
                          {%- for grandchild_link in child_link.links -%}
                            <li>
                              <a href="{{ grandchild_link.url }}" {% if grandchild_link.active %}aria-current="page"{% endif %}>
                                {{ grandchild_link.title }}
                              </a>
                            </li>
                          {%- endfor -%}
                        </ul>
                      {%- endif -%}
                    </li>
                  {%- endfor -%}
                </ul>
              {%- endif -%}
            </div>
          {%- endfor -%}
        </nav>
      </div>
      <div class="right-bar">
        <div class="mobile-product-page">
          <div class="sub-left-bar">
            <div class="gap-1">
              <img
                src="{{ featured_image | img_url: 'grande' }}"
                alt="{{ featured_image.alt | escape }}"
                id="ProductPhotoImg">
              {% for image in product.images %}
                <a href="{{ image.src | img_url: 'grande' }}">
                  <img
                    src="{{ image.src | img_url: 'compact' }}"
                    alt="{{ image.alt | escape }}"
                    id="SubProductPhotoImg">
                </a>
              {% endfor %}
            </div>
          </div>
          <div class="sub-right-bar">
            <div class="gap-1">
              <h1>{{ product.title }}</h1>
              <div class="product-prices">
                <p class="product-compare {%  unless product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %} hide {% endunless %} ">
                  {{ product.selected_or_first_available_variant.compare_at_price | money }}
                  <script>
                    decodeEntities("&lt;");
                    decodeEntities("&gt;");
                  </script>
                </p>
                <p class="product-price">
                  {{ product.selected_or_first_available_variant.price | money }}
                  <script>
                    decodeEntities("&lt;");
                    decodeEntities("&gt;");
                  </script>
                </p>
              </div>
              <div>{{ product.description }}</div>

              {% form 'product', product %}
                <input id="product-id" type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

                {% if product.variants.size > 1 %}

                  <div class="product-option">
                    {% for option in product.options_with_values %}
                      <fieldset style="display: block ruby; border: none;">
                        <legend>{{ option.name }}</legend>
                        {% for value in option.values %}
                          <div class="product-variant">
                            <input
                              {% if option.selected_value == value %}checked="checked"{% endif %}
                              type="radio"
                              name="{{ option.name }}"
                              value="{{ value }}"
                              id="{{ option.name | handleize}}-{{ value | handleize}}">
                            <label for="{ option.name | handleize}}-{{ value | handleize}}">
                              {{ value }}
                            </label>
                          </div>
                        {% endfor %}
                      </fieldset>
                    {% endfor %}
                  </div>

                {% endif %}

                <div class="product-option">
                  <label for="quantity">Quantity</label>
                  <input
                    id="quantity"
                    name="quantity"
                    value="1"
                    class="product-quantity">
                </div>

                <button type="submit" class="product-add"></button>
              {% endform %}


            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<iframe name="switch-page" style="display: none;"></iframe>

<script>
  var product = {{ product | json }};

  document.querySelectorAll('.product-option input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', () => {

      // find selection option
      var selectedOptions = [];

      document.querySelectorAll('.product-option input[type="radio"]:checked').forEach(radio => {
        selectedOptions.push(radio.value);
      })

      // finding the matched variant
      var matchedVariant = product.variants.find(variant => {
        var pass = true;

        for (var i = 0; i < selectedOptions.length; i++) {
          if (selectedOptions.indexOf(variant.options[i]) === -1) {
            pass = false;
            break;
          }
        }
        return pass;
      })
      
      // change product form variant id
      document.querySelector('#product-id').value = matchedVariant.id;

      // change url
      var url = new URLParse(window.location.href, true);
      url.query.variant = matchedVariant.id;
      window.history.replaceState(null, null, url.toString());
      
      // change price
      document.querySelector('.product-price').textContent = formatMoney(matchedVariant.price, "{{ shop.money_format }}" );
      document.querySelector('.product-compare').textContent = formatMoney(matchedVariant.compare_at_price, "{{ shop.money_format }}" );

      matchedVariant.compare_at_price > matchedVariant.price ? 
        document.querySelector('.product-compare').classList.remove('hide') : 
        document.querySelector('.product-compare').classList.add('hide');

    })
  })
</script>